<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Spotify Global Top‑10 History & Points</title>

  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  >
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      max-width: 1200px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    #date-select {
      padding: 0.3rem;
      font-size: 1rem;
    }
    .tables-container {
      display: flex;
      gap: 2rem;
    }
    table.dataTable {
      width: 100% !important;
    }
    .table-wrapper {
      flex: 1;
    }
  </style>
</head>
<body>

  <h1>Spotify Global Top‑10 History</h1>

  <div id="controls">
    <label for="date-select">Select date:</label>
    <select id="date-select"></select>
  </div>

  <div class="tables-container">
    <div class="table-wrapper">
      <table id="table-top10" class="display">
        <thead>
          <tr>
            <th>Position</th>
            <th>Change</th>
            <th>Song / Artist</th>
            <th>Streams</th>
            <th>Stream Diff</th>
            <th>Total</th>
            <th>Release Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="table-wrapper">
      <table id="table-points" class="display">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Song / Artist</th>
            <th>Points</th>
            <th>Release Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3>How does this work?</h3>
      Each day, each song of the top 10 wins points. 1st -> 12 pts, 2nd -> 10pts, 3rd -> 8 pts, 4th -> 7 pts,... 10th -> 1 pt. And here you'll see the total points it won.
      So, this system is a way to see it's popularity.
    </div>
  </div>

  <!-- jQuery + DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetch('spotify_historial.json')
        .then(res => res.json())
        .then(data => {
          // Sort dates descending
          const dates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));
          const select = document.getElementById('date-select');
          dates.forEach(date => {
            const opt = document.createElement('option');
            opt.value = date;
            opt.textContent = date;
            select.appendChild(opt);
          });

          // Initialize Top10 DataTable
          const top10Table = $('#table-top10').DataTable({
            columns: [
              { title: "Position" },
              { title: "Change" },
              { title: "Song / Artist" },
              { title: "Streams" },
              { title: "Stream Diff" },
              { title: "Total" },
              { title: "Release Date" }
            ],
            pageLength: 10,
            lengthChange: false,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/en-GB.json' }
          });

          // Initialize Points DataTable
          const pointsTable = $('#table-points').DataTable({
            columns: [
              { title: "Rank" },
              { title: "Song / Artist" },
              { title: "Points" },
              { title: "Release Date" }
            ],
            pageLength: 10,
            lengthChange: false,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/en-GB.json' }
          });
          
          const pointsMap = {};
          
          dates.forEach(date => {
            data[date].top_10.forEach(item => {
              const songName = item["Song / Artist"] || item["Canción / Artista"] || "";
              const key = songName.trim().toLowerCase();
              if (!key) return;
          
              const pos = Number(item.Posición || item.Position);
              if (!Number.isInteger(pos) || pos < 1 || pos > 10) return;
          
              let pts = 0;
              if (pos === 1) pts = 12;
              else if (pos === 2) pts = 10;
              else if (pos === 3) pts = 8;
              else if (pos >= 4 && pos <= 10) pts = 11 - pos;
          
              // CALCULA LA FECHA DE LANZAMIENTO
              let days = item["Release Days"] ?? item["Fecha de Lanzamiento"];
              if (days === -1) days = 0;
              let releaseDate = '-';
              if (!isNaN(days)) {
                const d = new Date(date);
                d.setDate(d.getDate() - parseInt(days));
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                releaseDate = `${y}/${m}/${da}`;
              }
          
              // Guarda la fecha de lanzamiento si todavía no la tenías
              if (!pointsMap[key]) {
                pointsMap[key] = { song: songName, points: 0, releaseDate };
              }
          
              pointsMap[key].points += pts;
            });
          });

          const pointsArray = Object.values(pointsMap)
            .sort((a, b) => b.points - a.points)
            .map((item, idx) => ({
              rank: idx + 1,
              song: item.song,
              points: item.points,
              releaseDate: item.releaseDate // <- agrega esto
            }));
          
          pointsArray.forEach(item => {
            pointsTable.row.add([item.rank, item.song, item.points, item.releaseDate]);
          });
          pointsTable.draw();

          // Render Top10 for selected date
          function renderDate(date) {
            top10Table.clear();
            data[date].top_10.forEach(item => {
              let days = item["Release Days"] ?? item["Fecha de Lanzamiento"];
              if (days === -1) days = 0;
              let releaseDate = '-';
              if (!isNaN(days)) {
                const d = new Date(date);
                d.setDate(d.getDate() - parseInt(days));
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                releaseDate = `${y}/${m}/${da}`;
              }
              top10Table.row.add([
                item.Posición ?? '-',
                item.Cambio ?? '-',
                item["Song / Artist"] ?? item["Canción / Artista"] ?? '-',
                item.Streams ?? '-',
                item["Stream Diff"] ?? '-',
                item.Total ?? '-',
                releaseDate
              ]);
            });
            top10Table.draw();
          }

          select.addEventListener('change', () => renderDate(select.value));
          if (dates.length) renderDate(dates[0]);
        })
        .catch(err => console.error('Error loading JSON:', err));
    });
  </script>

</body>
</html>
