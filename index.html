<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Spotify Global Top‑10 History & Points</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-bottom: 2rem;
      color: #1DB954;
      font-size: 2.8rem;
      font-weight: 700;
      letter-spacing: -1px;
      text-shadow: 0 0 10px rgba(29, 185, 84, 0.4);
    }
    #controls, #month-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: #181818;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    #controls label, #month-controls label {
      font-size: 1.1rem;
      margin-right: 1rem;
      color: #b3b3b3;
    }
    #date-select, #month-select {
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #333;
      background-color: #282828;
      color: #e0e0e0;
      appearance: none;
      cursor: pointer;
    }
    .tables-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 900px;
      gap: 2rem;
    }
    .table-wrapper {
      background-color: #181818;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
    table.dataTable {
      width: 100% !important;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table.dataTable thead th {
      background-color: #282828;
      color: #1DB954;
    }
    table.dataTable tbody td {
      color: #e0e0e0;
    }
    table.dataTable tbody tr:hover {
      background-color: #333333;
    }
  </style>
</head>
<body>
  <h1>Spotify Global Top‑10 History</h1>
  <div id="controls">
    <label for="date-select">Select date:</label>
    <select id="date-select"></select>
  </div>
  <div id="month-controls">
    <label for="month-select">Select month:</label>
    <select id="month-select"></select>
  </div>
  <div class="tables-container">
    <div class="table-wrapper">
      <table id="table-top10" class="display">
        <thead>
          <tr>
            <th>Position</th>
            <th>Change</th>
            <th>Song / Artist</th>
            <th>Streams</th>
            <th>Stream Diff</th>
            <th>Total</th>
            <th>Release Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="table-wrapper">
      <table id="table-points" class="display">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Song / Artist</th>
            <th>Points</th>
            <th>Release Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="table-wrapper">
      <table id="table-monthly-points" class="display">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Song / Artist</th>
            <th>Points (in month)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetch('spotify_historial.json')
        .then(res => res.json())
        .then(data => {
          const dates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));
          const select = document.getElementById('date-select');
          dates.forEach(date => {
            const opt = document.createElement('option');
            opt.value = date;
            opt.textContent = date;
            select.appendChild(opt);
          });
          const top10Table = $('#table-top10').DataTable({
            autoWidth: false,
            searching: true,
            columns: [
              { title: "Position" },
              { title: "Change" },
              { title: "Song / Artist" },
              { title: "Streams" },
              { title: "Stream Diff" },
              { title: "Total" },
              { title: "Release Date" }
            ],
            pageLength: 10,
            lengthChange: false,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/en-GB.json' }
          });
          const pointsTable = $('#table-points').DataTable({
            autoWidth: false,
            searching: true,
            columns: [
              { title: "Rank" },
              { title: "Song / Artist" },
              { title: "Points" },
              { title: "Release Date" }
            ],
            pageLength: 10,
            lengthChange: false,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/en-GB.json' }
          });
          const pointsMap = {};
          dates.forEach(date => {
            data[date].top_10.forEach(item => {
              const songName = item["Song / Artist"] || item["Canción / Artista"] || "";
              const key = songName.trim().toLowerCase();
              if (!key) return;
              const pos = Number(item.Posición || item.Position);
              if (!Number.isInteger(pos) || pos < 1 || pos > 10) return;
              let pts = 0;
              if (pos === 1) pts = 12;
              else if (pos === 2) pts = 10;
              else if (pos === 3) pts = 8;
              else if (pos >= 4 && pos <= 10) pts = 11 - pos;
              let days = item["Release Days"] ?? item["Fecha de Lanzamiento"];
              if (days === -1) days = 0;
              let releaseDate = '-';
              if (!isNaN(days)) {
                const d = new Date(date);
                d.setDate(d.getDate() - parseInt(days));
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                releaseDate = ${y}/${m}/${da};
              }
              if (!pointsMap[key]) {
                pointsMap[key] = { song: songName, points: 0, releaseDate };
              }
              pointsMap[key].points += pts;
            });
          });
          const pointsArray = Object.values(pointsMap)
            .sort((a, b) => b.points - a.points)
            .map((item, idx) => ({
              rank: idx + 1,
              song: item.song,
              points: item.points,
              releaseDate: item.releaseDate
            }));
          pointsArray.forEach(item => {
            pointsTable.row.add([item.rank, item.song, item.points, item.releaseDate]);
          });
          pointsTable.draw();
          function renderDate(date) {
            top10Table.clear();
            data[date].top_10.forEach(item => {
              let days = item["Release Days"] ?? item["Fecha de Lanzamiento"];
              if (days === -1) days = 0;
              let releaseDate = '-';
              if (!isNaN(days)) {
                const d = new Date(date);
                d.setDate(d.getDate() - parseInt(days));
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                releaseDate = ${y}/${m}/${da};
              }
              top10Table.row.add([
                item.Posición ?? '-',
                item.Cambio ?? '-',
                item["Song / Artist"] ?? item["Canción / Artista"] ?? '-',
                item.Streams ?? '-',
                item["Stream Diff"] ?? '-',
                item.Total ?? '-',
                releaseDate
              ]);
            });
            top10Table.draw();
          }
          select.addEventListener('change', () => renderDate(select.value));
          if (dates.length) renderDate(dates[0]);
        })
        .catch(err => console.error('Error loading JSON:', err));
    });
  </script>
</body>
</html>
