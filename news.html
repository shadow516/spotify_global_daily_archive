<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novedades del Top 10 Global de Spotify</title>
   <style>
        /* Estilos básicos si no usas un CSS externo para esta página */
        body {
            font-family: 'Poppins', sans-serif; /* Asumiendo que quieres la misma fuente */
            margin: 0;
            padding: 2rem;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #181818;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        h1, h2 {
            color: #1DB954; /* Verde Spotify */
            border-bottom: 1px solid #282828;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }
        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }
        p, li {
            font-size: 1rem;
            color: #b3b3b3;
        }
        strong {
            color: #e0e0e0;
            font-weight: 600;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            background-color: #282828;
            margin-bottom: 0.75rem;
            padding: 1rem;
            border-radius: 5px;
            border-left: 3px solid #1DB954;
        }
        .highlight {
            color: #1DB954;
            font-weight: bold;
        }
        .date-header {
            text-align: center;
            font-size: 1.2rem;
            color: #b3b3b3;
            margin-bottom: 2rem;
        }
         /* Botón para volver al dashboard principal */
        .back-button {
            display: inline-block;
            margin-bottom: 2rem;
            padding: 10px 20px;
            background-color: #1DB954;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: #1AA34A;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">← Volver al Dashboard Principal</a>

        <h1>Novedades del Top 10 Global</h1>
        <p id="fecha-actualizacion" class="date-header">Cargando datos...</p>

        <div id="resumen-novedades">
            </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const resumenContainer = document.getElementById('resumen-novedades');
        const fechaHeader = document.getElementById('fecha-actualizacion');

        // --- Funciones Auxiliares ---
        function parseSongArtistForDisplay(songArtistString) {
            if (!songArtistString) return { artist: 'Desconocido', song: 'Desconocida' };
            const parts = songArtistString.split(' - ');
            if (parts.length > 1) {
                const artist = parts.shift().trim();
                const song = parts.join(' - ').trim();
                return { artist, song };
            }
            return { artist: 'Artista Desconocido', song: songArtistString.trim() };
        }

        function formatNumber(num) {
            if (typeof num === 'string' && num.includes(',')) num = num.replace(/,/g, ''); // Remover comas si es string
            const number = parseInt(num, 10);
            return isNaN(number) ? '-' : number.toLocaleString('es-ES');
        }

        function getPositionChangeText(currentPos, prevPos) {
            if (prevPos === null || prevPos === undefined) return "<span class='highlight'>(Nueva Entrada)</span>";
            const change = prevPos - currentPos;
            if (change > 0) return `(Sube <span class='highlight'>${change}</span> ${change === 1 ? 'posición' : 'posiciones'})`;
            if (change < 0) return `(Baja <span class='highlight'>${Math.abs(change)}</span> ${Math.abs(change) === 1 ? 'posición' : 'posiciones'})`;
            return "(Mantiene posición)";
        }


        fetch('spotify_historial.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const dates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));
                
                if (dates.length === 0) {
                    resumenContainer.innerHTML = "<p>No hay datos disponibles en el historial.</p>";
                    fechaHeader.textContent = "No hay datos";
                    return;
                }

                const latestDate = dates[0];
                const previousDate = dates.length > 1 ? dates[1] : null;

                const latestTop10 = data[latestDate]?.top_10 || [];
                const previousTop10Data = previousDate ? (data[previousDate]?.top_10 || []) : [];

                // Mapear el top 10 anterior para búsqueda fácil
                const previousSongsMap = new Map();
                previousTop10Data.forEach(song => {
                    const key = (song["Song / Artist"] || song["Canción / Artista"] || "").toLowerCase();
                    if (key) {
                        previousSongsMap.set(key, song);
                    }
                });
                
                // Formatear la fecha para mostrarla
                const displayDate = new Date(latestDate).toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                fechaHeader.textContent = `Análisis del ${displayDate}`;

                let htmlOutput = "";

                // 1. Panorama General
                htmlOutput += `<h2>Panorama General del Día</h2>`;
                if (latestTop10.length > 0) {
                    const { song: songN1, artist: artistN1 } = parseSongArtistForDisplay(latestTop10[0]["Song / Artist"] || latestTop10[0]["Canción / Artista"]);
                    htmlOutput += `<p>El día de hoy, <strong>${songN1}</strong> de <strong>${artistN1}</strong> lidera el Top 10 Global.</p>`;
                } else {
                     htmlOutput += `<p>No hay datos para el Top 10 del día de hoy.</p>`;
                }


                // 2. Nuevas Entradas y Movimientos
                const newEntries = [];
                const movements = []; // Para subidas, bajadas, mantenimientos

                latestTop10.forEach(currentSong => {
                    const songKey = (currentSong["Song / Artist"] || currentSong["Canción / Artista"] || "").toLowerCase();
                    const parsedCurrent = parseSongArtistForDisplay(currentSong["Song / Artist"] || currentSong["Canción / Artista"]);
                    const currentPos = parseInt(currentSong.Posición || currentSong.Position, 10);
                    const currentStreams = formatNumber(currentSong.Streams);

                    const prevSongData = previousSongsMap.get(songKey);
                    const prevPos = prevSongData ? parseInt(prevSongData.Posición || prevSongData.Position, 10) : null;
                    
                    const changeText = getPositionChangeText(currentPos, prevPos);

                    let listItem = `<li><strong>#${currentPos} ${parsedCurrent.song}</strong> - ${parsedCurrent.artist} ${changeText}. Streams: ${currentStreams}.`;
                    if (currentSong["Stream Diff"]) {
                        const diff = parseInt(String(currentSong["Stream Diff"]).replace(/,/g, ''), 10); // Limpiar y convertir
                        if (!isNaN(diff)) {
                             listItem += ` Diferencia: <span class="${diff >= 0 ? 'highlight' : 'negative-highlight'}">${formatNumber(diff)}</span>.`;
                        }
                    }
                     listItem += `</li>`;


                    if (prevPos === null) {
                        newEntries.push(listItem);
                    } else {
                        movements.push({pos: currentPos, item: listItem});
                    }
                });
                
                // Ordenar 'movements' por posición actual para mostrarlos en orden
                movements.sort((a,b) => a.pos - b.pos);


                if (newEntries.length > 0) {
                    htmlOutput += `<h2>Nuevas Entradas en el Top 10</h2><ul>${newEntries.join('')}</ul>`;
                } else {
                    htmlOutput += `<h2>Nuevas Entradas en el Top 10</h2><p>No hay nuevas entradas en el Top 10 hoy.</p>`;
                }

                htmlOutput += `<h2>Movimientos y Posiciones Actuales</h2>`;
                if (movements.length > 0) {
                     htmlOutput += `<ul>${movements.map(m => m.item).join('')}</ul>`;
                } else if (newEntries.length === 0) { // Si no hay movimientos ni nuevas entradas (raro)
                     htmlOutput += `<p>El Top 10 se mantiene idéntico al día anterior o no hay datos suficientes para comparar.</p>`;
                } else { // Si solo hubo nuevas entradas pero no otros movimientos (porque el resto salió)
                     htmlOutput += `<p>Todas las canciones que no son nuevas entradas han salido del Top 10.</p>`;
                }


                // 3. Hitos Destacados
                htmlOutput += `<h2>Hitos y Datos Destacados</h2>`;
                let hitosList = "<ul>";
                let noHitos = true;

                // Canción con más streams
                if (latestTop10.length > 0) {
                    let maxStreams = -1;
                    let songMaxStreams = null;
                    latestTop10.forEach(s => {
                        const streams = parseInt(String(s.Streams).replace(/,/g, ''), 10);
                        if (!isNaN(streams) && streams > maxStreams) {
                            maxStreams = streams;
                            songMaxStreams = s;
                        }
                    });
                    if (songMaxStreams) {
                        const parsed = parseSongArtistForDisplay(songMaxStreams["Song / Artist"] || songMaxStreams["Canción / Artista"]);
                        hitosList += `<li><strong>Líder en Streams:</strong> '${parsed.song}' de ${parsed.artist} es la canción con más streams hoy, acumulando <strong>${formatNumber(maxStreams)}</strong> reproducciones.</li>`;
                        noHitos = false;
                    }
                }
                
                // Canción con mayor aumento de streams (Stream Diff)
                if (latestTop10.length > 0 && previousDate) { // Solo si hay día anterior para comparar
                    let maxStreamDiff = -Infinity; // Empezar bajo para encontrar el máximo positivo
                    let songMaxStreamDiff = null;
                    latestTop10.forEach(s => {
                        if (s["Stream Diff"]) {
                            const diff = parseInt(String(s["Stream Diff"]).replace(/,/g, ''), 10);
                            if (!isNaN(diff) && diff > maxStreamDiff) {
                                maxStreamDiff = diff;
                                songMaxStreamDiff = s;
                            }
                        }
                    });

                    if (songMaxStreamDiff && maxStreamDiff > 0) { // Solo mostrar si hay un aumento positivo
                        const parsed = parseSongArtistForDisplay(songMaxStreamDiff["Song / Artist"] || songMaxStreamDiff["Canción / Artista"]);
                        hitosList += `<li><strong>Mayor Crecimiento:</strong> '${parsed.song}' de ${parsed.artist} tuvo el mayor aumento en streams respecto al día anterior, con <strong>+${formatNumber(maxStreamDiff)}</strong> streams.</li>`;
                        noHitos = false;
                    }
                }

                // Si el #1 se mantuvo y estaba en el día anterior
                if (latestTop10.length > 0 && previousTop10Data.length > 0) {
                    const currentN1Key = (latestTop10[0]["Song / Artist"] || latestTop10[0]["Canción / Artista"] || "").toLowerCase();
                    const prevN1Key = (previousTop10Data[0]["Song / Artist"] || previousTop10Data[0]["Canción / Artista"] || "").toLowerCase();
                    if (currentN1Key === prevN1Key && parseInt(latestTop10[0].Posición || latestTop10[0].Position, 10) === 1) {
                         const parsed = parseSongArtistForDisplay(latestTop10[0]["Song / Artist"] || latestTop10[0]["Canción / Artista"]);
                         hitosList += `<li><strong>Consolidado en la Cima:</strong> '${parsed.song}' de ${parsed.artist} se mantiene firme en la posición <strong>#1</strong>.</li>`;
                         noHitos = false;
                    }
                }


                if (noHitos) {
                    hitosList += "<li>No hay hitos especiales que destacar hoy o datos insuficientes para algunos cálculos.</li>";
                }
                hitosList += "</ul>";
                htmlOutput += hitosList;

                resumenContainer.innerHTML = htmlOutput;

            })
            .catch(error => {
                console.error('Error al cargar o procesar los datos:', error);
                resumenContainer.innerHTML = `<p>Ocurrió un error al cargar las novedades. Revisa la consola para más detalles. Asegúrate de que el archivo <code>spotify_historial.json</code> es accesible y tiene el formato correcto.</p>`;
                fechaHeader.textContent = "Error";
            });
    });
    </script>
</body>
</html>
